name: Kubernetes Deployment

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  deploy-pod:
    runs-on: self-hosted

    steps:
      - name: Check out code repository
        uses: actions/checkout@v4
        with:
          # voorkomt agressieve clean errors/warnings op Windows
          clean: false
          fetch-depth: 0
          submodules: false

      - name: Generate random pod name (PowerShell)
        shell: pwsh
        run: |
          $epoch = [DateTimeOffset]::UtcNow.ToUnixTimeSeconds()
          "POD_NAME=mypod-$epoch" >> $env:GITHUB_OUTPUT
        id: random

      - name: Update pod YAML with random name (PowerShell)
        shell: pwsh
        run: |
          (Get-Content kubernetes-pod.yaml) -replace 'PLACEHOLDER', '${{ steps.random.outputs.POD_NAME }}' |
            Set-Content kubernetes-pod.yaml

      # Optioneel: expliciet kubeconfig meegeven als kubectl je cluster niet vindt
      - name: Deploy pod to Kubernetes
        shell: pwsh
        run: |
          kubectl --kubeconfig "$env:USERPROFILE\.kube\config" apply -f kubernetes-pod.yaml

      - name: Wait for pod to be ready
        shell: pwsh
        run: |
          kubectl --kubeconfig "$env:USERPROFILE\.kube\config" wait --for=condition=Ready pod/${{ steps.random.outputs.POD_NAME }} -n rune --timeout=60s

      - name: Check pods in namespace
        shell: pwsh
        run: |
          kubectl --kubeconfig "$env:USERPROFILE\.kube\config" get pods -n rune

      - name: Get pod details
        shell: pwsh
        run: |
          kubectl --kubeconfig "$env:USERPROFILE\.kube\config" describe pod/${{ steps.random.outputs.POD_NAME }} -n rune
