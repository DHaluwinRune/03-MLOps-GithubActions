name: Kubernetes Deployment

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy-pod:
    runs-on: self-hosted
    
    steps:
      - name: Check out code repository
        uses: actions/checkout@v4
      
      - name: Generate random pod name
        id: random
        shell: pwsh
        run: |
          $now = Get-Date -UFormat %s
          echo "POD_NAME=mypod-$now" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      
      - name: Update pod YAML with random name
        run: |
          sed -i 's/PLACEHOLDER/${{ steps.random.outputs.POD_NAME }}/g' kubernetes-pod.yaml
      
      - name: Deploy pod to Kubernetes
        run: |
          kubectl apply -f kubernetes-pod.yaml
      
      - name: Check pods in namespace
        run: |
          kubectl get pods -n rune
  
  deploy-application:
    runs-on: self-hosted
    needs: deploy-pod
    
    steps:
      - name: Check out code repository
        uses: actions/checkout@v4
      
      - name: Deploy Deployment to Kubernetes
        run: |
          kubectl apply -f kubernetes-deployment.yaml
      
      - name: Deploy Service to Kubernetes
        run: |
          kubectl apply -f kubernetes-service.yaml
      
      - name: Wait for deployment to be ready
        run: |
          kubectl rollout status deployment/hello-world-deployment -n rune --timeout=120s
      
      - name: Check deployment status
        run: |
          kubectl get deployments -n rune
          kubectl get pods -n rune
          kubectl get services -n rune
      
      - name: Restart deployment to pull latest image
        run: |
          kubectl rollout restart deployment/hello-world-deployment -n rune
