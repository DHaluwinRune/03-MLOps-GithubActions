name: Kubernetes Deployment

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy-pod:
    runs-on: self-hosted
    
    steps:
      - name: Check out code repository
        uses: actions/checkout@v4
      
      - name: Generate random pod name
        id: random
        shell: powershell
        run: |
          $now = [DateTimeOffset]::UtcNow.ToUnixTimeSeconds()
          Add-Content -Path $env:GITHUB_OUTPUT -Value "POD_NAME=mypod-$now"
      
      - name: Update pod YAML with random name
        shell: powershell
        run: |
          $file = 'kubernetes-pod.yaml'
          $old = 'PLACEHOLDER'
          $new = '${{ steps.random.outputs.POD_NAME }}'
          (Get-Content $file) -replace $old, $new | Set-Content $file
      
      - name: Deploy pod to Kubernetes
        run: |
          kubectl apply -f kubernetes-pod.yaml
      
      - name: Check pods in namespace
        run: |
          kubectl get pods -n rune
  
  deploy-application:
    runs-on: self-hosted
    needs: deploy-pod
    
    steps:
      - name: Check out code repository
        uses: actions/checkout@v4
      
      - name: Deploy Deployment to Kubernetes
        run: |
          kubectl apply -f kubernetes-deployment.yaml
      
      - name: Deploy Service to Kubernetes
        run: |
          kubectl apply -f kubernetes-service.yaml
      
      - name: Wait for deployment to be ready
        run: |
          kubectl rollout status deployment/hello-world-deployment -n rune --timeout=120s
      
      - name: Check deployment status
        run: |
          kubectl get deployments -n rune
          kubectl get pods -n rune
          kubectl get services -n rune
      
      - name: Restart deployment to pull latest image
        run: |
          kubectl rollout restart deployment/hello-world-deployment -n rune
  
  deploy-with-helm:
    runs-on: self-hosted
    needs: deploy-application
    
    steps:
      - name: Check out code repository
        uses: actions/checkout@v4
      
      - name: Create namespace if not exists
        run: |
          kubectl create namespace rune --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Deploy using Helm
        run: |
          helm upgrade --install hello-world-nginx ./helm-chart \
            --namespace rune \
            --create-namespace \
            --set image.tag=latest \
            --wait \
            --timeout 2m
      
      - name: Check Helm release
        run: |
          helm list -n rune
      
      - name: Check deployed resources
        run: |
          kubectl get all -n rune
