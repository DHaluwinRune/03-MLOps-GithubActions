name: Kubernetes Pod Deployment

on:
  workflow_dispatch:  # Handmatig triggeren
  push:
    branches:
      - main

jobs:
  deploy-pod:
    runs-on: self-hosted  # Gebruik je self-hosted runner
    
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      # Genereer een random ID voor de pod naam (Windows Powershell)
      - name: Generate random ID (Windows)
        id: random-id
        shell: powershell
        run: |
          $random = Get-Random
          $timestamp = [int][double]::Parse((Get-Date -UFormat %s))
          $random_id = "$timestamp-$random"
          echo "random_id=$random_id" >> $env:GITHUB_OUTPUT
          Write-Host "Generated random ID: $random_id"

      # Vervang de placeholder in pod.yaml met random ID (Powershell!)
      - name: Update pod name with random ID
        shell: powershell
        run: |
          $file = "kubernetes-pod.yaml"
          $content = Get-Content $file
          $random_id = "${{ steps.random-id.outputs.random_id }}"
          $content = $content -replace "PLACEHOLDER", $random_id
          Set-Content $file $content
          Get-Content $file

      # Deploy de pod naar Kubernetes
      - name: Apply Kubernetes Pod
        run: |
          kubectl apply -f kubernetes-pod.yaml

      # Controleer de pods in je namespace
      - name: Check pods in namespace
        run: |
          kubectl get pods -n rune